rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- REGRA CORRIGIDA ---
    // Permite que um usuário leia seu próprio documento, e que administradores leiam qualquer documento.
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'Administrador');
      allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }

    // Regras existentes que já adicionamos (confirme que elas estão aqui)
    match /ubs/{ubsId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }

    match /equipes/{equipeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }
    
    match /estoqueTestesRapidos/{loteId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }
    
    match /movimentacoesEstoque/{movId} {
       allow read: if request.auth != null;
       allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }

    match /boletimTestes/{testeId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }
    
    match /boletimLiberacoes/{competencia} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.role == 'Administrador';
    }
    
    // Regras para os dados que os enfermeiros/gerentes irão criar
    // Adicionando de forma proativa para evitar erros futuros
    match /{colecao}/{documentoId} {
      allow read, write: if request.auth != null;
    }
  }
}